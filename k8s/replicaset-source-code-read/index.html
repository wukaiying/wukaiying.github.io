<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Replica Set Controller 源码分析 - Kaiying</title>
  <meta property="og:title" content="Replica Set Controller 源码分析 - Kaiying" />
  <meta name="twitter:title" content="Replica Set Controller 源码分析 - Kaiying" />
  <meta name="description" content="replicaset controller源码分析">
  <meta property="og:description" content="replicaset controller源码分析">
  <meta name="twitter:description" content="replicaset controller源码分析">
  <meta name="author" content="kaiying"/>
  <meta property="og:site_name" content="Kaiying" />
  <meta property="og:url" content="https://wukaiying.github.io/k8s/replicaset-source-code-read/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.61.0" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">Kaiying</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">Replica Set Controller 源码分析</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>April 21, 2020</time></li>
        <li class="article-meta-categories">
          <a href="/categories/k8s/">
            <i class="fas fa-folder"></i>
            k8s
          </a>&nbsp;
        </li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#heading">版本环境</a></li>
        <li><a href="#heading-1">前言</a></li>
        <li><a href="#heading-2">源码分析</a></li>
        <li><a href="#heading-4">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>
      <h3 id="heading">版本环境</h3>
<p>kubernetes版本：kubernetes:v1.16.0</p>
<p>go环境：go version go1.13.4 darwin/amd64</p>
<h3 id="heading-1">前言</h3>
<p>前面文章已经总结到，deployment controller通过replicaset来控制pod的创建和删除，进而实现更高级操作例如，滚动更新，回滚等。本文继续从源码角度
分析replicaset controller如何控制pod的创建和删除。</p>
<p>在分析源码前先考虑一下 replicaset 的使用场景，在平时的操作中其实我们并不会直接操作 replicaset，replicaset 也仅有几个简单的操作，创建、删除、更新等。</p>
<h3 id="heading-2">源码分析</h3>
<h4 id="heading-3">入口</h4>
<p>我们在上一篇文章中也说道controller manager是所有k8s 资源controller的管控中心，包含的主要逻辑就是高可用选择leader，然后
遍历所有的controllers,对每一个controller进行初始化并启动，也就是说只要集群启动，所有的controller也会都启动起来，开始list-watch api server，来准备创建资源。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cmd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manager</span><span style="color:#f92672">/</span><span style="color:#a6e22e">app</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controllermanager</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">386</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewControllerInitializers</span>(<span style="color:#a6e22e">loopMode</span> <span style="color:#a6e22e">ControllerLoopMode</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">InitFunc</span> {
	<span style="color:#a6e22e">controllers</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">InitFunc</span>{}
	<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;endpoint&#34;</span>] = <span style="color:#a6e22e">startEndpointController</span>
	<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;endpointslice&#34;</span>] = <span style="color:#a6e22e">startEndpointSliceController</span>
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;deployment&#34;</span>] = <span style="color:#a6e22e">startDeploymentController</span>
	<span style="color:#a6e22e">controllers</span>[<span style="color:#e6db74">&#34;replicaset&#34;</span>] = <span style="color:#a6e22e">startReplicaSetController</span>
}
</code></pre></div><p>接下来进入<code>startReplicaSetController</code>, 发现通过<code>NewReplicaSetController</code>初始化了ReplicaSetController，并并调用run方法启动controller。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cmd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manager</span><span style="color:#f92672">/</span><span style="color:#a6e22e">app</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apps</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">69</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">startReplicaSetController</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ControllerContext</span>) (<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">AvailableResources</span>[<span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionResource</span>{<span style="color:#a6e22e">Group</span>: <span style="color:#e6db74">&#34;apps&#34;</span>, <span style="color:#a6e22e">Version</span>: <span style="color:#e6db74">&#34;v1&#34;</span>, <span style="color:#a6e22e">Resource</span>: <span style="color:#e6db74">&#34;replicasets&#34;</span>}] {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">replicaset</span>.<span style="color:#a6e22e">NewReplicaSetController</span>(
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">ReplicaSets</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Pods</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ClientBuilder</span>.<span style="color:#a6e22e">ClientOrDie</span>(<span style="color:#e6db74">&#34;replicaset-controller&#34;</span>),
		<span style="color:#a6e22e">replicaset</span>.<span style="color:#a6e22e">BurstReplicas</span>,
	).<span style="color:#a6e22e">Run</span>(int(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">ReplicaSetController</span>.<span style="color:#a6e22e">ConcurrentRSSyncs</span>), <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Stop</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>我们先分析<code>NewReplicaSetController</code>看一下初始化<code>ReplicaSetController</code>的具体步骤：发现他会监听rs的add,update,delete操作，和pod的add,update,delete操作。
当这两种资源发送变化时，将key(name+namespace)添加到queue队列中去。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//pkg/controller/replicaset/replica_set.go:126
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewBaseController</span>(<span style="color:#a6e22e">rsInformer</span> <span style="color:#a6e22e">appsinformers</span>.<span style="color:#a6e22e">ReplicaSetInformer</span>, <span style="color:#a6e22e">podInformer</span> <span style="color:#a6e22e">coreinformers</span>.<span style="color:#a6e22e">PodInformer</span>, <span style="color:#a6e22e">kubeClient</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">burstReplicas</span> <span style="color:#66d9ef">int</span>,
	<span style="color:#a6e22e">gvk</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionKind</span>, <span style="color:#a6e22e">metricOwnerName</span>, <span style="color:#a6e22e">queueName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">podControl</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">PodControlInterface</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ReplicaSetController</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">RESTClient</span>().<span style="color:#a6e22e">GetRateLimiter</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">RegisterMetricAndTrackRateLimiterUsage</span>(<span style="color:#a6e22e">metricOwnerName</span>, <span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">RESTClient</span>().<span style="color:#a6e22e">GetRateLimiter</span>())
	}

	<span style="color:#a6e22e">rsc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ReplicaSetController</span>{
		<span style="color:#a6e22e">GroupVersionKind</span>: <span style="color:#a6e22e">gvk</span>,
		<span style="color:#a6e22e">kubeClient</span>:       <span style="color:#a6e22e">kubeClient</span>,
		<span style="color:#a6e22e">podControl</span>:       <span style="color:#a6e22e">podControl</span>,
		<span style="color:#a6e22e">burstReplicas</span>:    <span style="color:#a6e22e">burstReplicas</span>,
		<span style="color:#a6e22e">expectations</span>:     <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">NewUIDTrackingControllerExpectations</span>(<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">NewControllerExpectations</span>()),
		<span style="color:#a6e22e">queue</span>:            <span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">NewNamedRateLimitingQueue</span>(<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">DefaultControllerRateLimiter</span>(), <span style="color:#a6e22e">queueName</span>),
	}

	<span style="color:#a6e22e">rsInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>:    <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">enqueueReplicaSet</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">updateRS</span>,
		
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">enqueueReplicaSet</span>,
	})
	<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">rsLister</span> = <span style="color:#a6e22e">rsInformer</span>.<span style="color:#a6e22e">Lister</span>()
	<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">rsListerSynced</span> = <span style="color:#a6e22e">rsInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>

	<span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">addPod</span>,
		
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">updatePod</span>,
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">deletePod</span>,
	})
	<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">podLister</span> = <span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Lister</span>()
	<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">podListerSynced</span> = <span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>

	<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">syncHandler</span> = <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">syncReplicaSet</span>

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rsc</span>
}
</code></pre></div><p>接着我们再看<code>NewReplicaSetController</code>的Run方法：可以看到run方法会启动worker(默认5个)数量的goroutine来从queue中取出key,然后执行synchanlder操作。
下面会详细说明synchandler中的具体逻辑。补充一句，大部分contoller逻辑都是如此，流程就是注册name+startcontrollerhandler到 controller manager中，比如<code>controllers[&quot;replicaset&quot;] = startReplicaSetController</code>
controller manager 会循环启动所有已经注册的name+startcontrollerhandler，对于每一个controller中的具体逻辑，又是通过NewxxxController.Run()的方式执行，
NewxxxCtronller是为了初始化controller，指定controller中需要监听的资源(比如，replicasetcontroller 他需要监听replicaset，pod这个两个资源的变化，而deploymentcontroller 它需要监听deployment,replicaset,pod这三个资源的变化, 具体变化包括add,update,delete
这三种操作，每个操作可以写相应的逻辑来更新informer catche，修改完成后将key入队)
初始化完资源后，调用Run方法，启动controller，此时Controller会启动指定数量个worker goroutine来从informer队列中拿到key，获取informer catche中的资源和实际集群中的资源进行比较，
此时就进入了每个worker goroutine的synchandler逻辑当中。synchanlder就是核心谐调逻辑。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//pkg/controller/replicaset/replica_set.go:177
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReplicaSetController</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">workers</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">ShutDown</span>()

	<span style="color:#a6e22e">controllerName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">ToLower</span>(<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>)
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Starting %v controller&#34;</span>, <span style="color:#a6e22e">controllerName</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Shutting down %v controller&#34;</span>, <span style="color:#a6e22e">controllerName</span>)

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">WaitForNamedCacheSync</span>(<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">podListerSynced</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">rsListerSynced</span>) {
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">workers</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">worker</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
	}

	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
}

<span style="color:#75715e">//pkg/controller/replicaset/replica_set.go:432
</span><span style="color:#75715e"></span><span style="color:#75715e">//每一个worker goroutine都会从informer队列中取出key,然后执行synchandler操作。
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReplicaSetController</span>) <span style="color:#a6e22e">worker</span>() {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">processNextWorkItem</span>() {
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReplicaSetController</span>) <span style="color:#a6e22e">processNextWorkItem</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">quit</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Get</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">quit</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Done</span>(<span style="color:#a6e22e">key</span>)

	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">syncHandler</span>(<span style="color:#a6e22e">key</span>.(<span style="color:#66d9ef">string</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}

	<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Sync %q failed with %v&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">err</span>))
	<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">AddRateLimited</span>(<span style="color:#a6e22e">key</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}
</code></pre></div><p>synchandler中描述了特定类型controller的核心操作逻辑，不断的从informer 队列中拿到key, 对informer catche和当前集群实际资源，并进行比较，以达到期望。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//pkg/controller/replicaset/replica_set.go:552
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReplicaSetController</span>) <span style="color:#a6e22e">syncReplicaSet</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {

	<span style="color:#a6e22e">startTime</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Finished syncing %v %q (%v)&#34;</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">startTime</span>))
	}()

    <span style="color:#75715e">//1.通过key获取namespace, name
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SplitMetaNamespaceKey</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
    
    <span style="color:#75715e">//获取catche中的rs
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">rsLister</span>.<span style="color:#a6e22e">ReplicaSets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;%v %v has been deleted&#34;</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">key</span>)
		<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">DeleteExpectations</span>(<span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">rsNeedsSync</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">SatisfiedExpectations</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#a6e22e">selector</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelectorAsSelector</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Error converting pod selector to selector: %v&#34;</span>, <span style="color:#a6e22e">err</span>))
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// list all pods to include the pods that don&#39;t match the rs`s selector
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// anymore but has the stale controller ref.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO: Do the List and Filter in a single pass, or use an index.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">allPods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">podLister</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">labels</span>.<span style="color:#a6e22e">Everything</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">// Ignore inactive pods.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">filteredPods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">FilterActivePods</span>(<span style="color:#a6e22e">allPods</span>)

	<span style="color:#75715e">// NOTE: filteredPods are pointing to objects from cache - if you need to
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// modify them, you need to copy it first.
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">//筛选出和当前rs有关联的所有pod
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">filteredPods</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">claimPods</span>(<span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">selector</span>, <span style="color:#a6e22e">filteredPods</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

    <span style="color:#75715e">//对比当前集群pod数量和informer cache中replicaset.spec.repica的大小，进行创建或者删除pod
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">manageReplicasErr</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rsNeedsSync</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">manageReplicasErr</span> = <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">manageReplicas</span>(<span style="color:#a6e22e">filteredPods</span>, <span style="color:#a6e22e">rs</span>)
	}
	<span style="color:#a6e22e">rs</span> = <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">DeepCopy</span>()
	<span style="color:#a6e22e">newStatus</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">calculateStatus</span>(<span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">filteredPods</span>, <span style="color:#a6e22e">manageReplicasErr</span>)

	<span style="color:#75715e">// Always updates status as pods come up or die.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//最后更新replicaset 状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">updatedRS</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">updateReplicaSetStatus</span>(<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">AppsV1</span>().<span style="color:#a6e22e">ReplicaSets</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>), <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">newStatus</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// Multiple things could lead to this update failing. Requeuing the replica set ensures
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Returning an error causes a requeue without forcing a hotloop
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">// Resync the ReplicaSet after MinReadySeconds as a last line of defense to guard against clock-skew.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">manageReplicasErr</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">updatedRS</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">MinReadySeconds</span> &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span>
		<span style="color:#a6e22e">updatedRS</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">ReadyReplicas</span> <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">updatedRS</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>) <span style="color:#f92672">&amp;&amp;</span>
		<span style="color:#a6e22e">updatedRS</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">AvailableReplicas</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(<span style="color:#a6e22e">updatedRS</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>) {
		<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">enqueueReplicaSetAfter</span>(<span style="color:#a6e22e">updatedRS</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">updatedRS</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">MinReadySeconds</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">manageReplicasErr</span>
}
</code></pre></div><p>看一下syncReplicaset中最核心逻辑<code>manageReplicas</code>，主要步骤如下：</p>
<ol>
<li>计算出实际pod数量和期望pod数量的差值</li>
<li>如果差值小于0，需要创建新的pod，通过slowStartBatch批量创建pod，返回成功创建的数量
2.1  //通过slowStartBatch批量创建pod，返回成功创建的数量
2.2 //对比差异，看还有缺多个pod没有创建
2.3 如果真的还有pod没有创建，则会在下一次谐调循环中继续从1开始</li>
<li>//如果diff 大于0，则说明需要进行删除pod
3.1 // 通过一定的策略返回需要删除的pod,	 not-ready &lt; ready, unscheduled &lt; scheduled, and pending &lt; running.
3.2 //执行删除操作
3.3 //如果某个一个goroutine有错误，则返回错误，会进入下次一次谐调循环</li>
<li>下次循环进入，直到达到期望</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//pkg/controller/replicaset/replica_set.go:459
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ReplicaSetController</span>) <span style="color:#a6e22e">manageReplicas</span>(<span style="color:#a6e22e">filteredPods</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>, <span style="color:#a6e22e">rs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">ReplicaSet</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">//计算出实际pod数量和期望pod数量的差值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">diff</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">filteredPods</span>) <span style="color:#f92672">-</span> int(<span style="color:#f92672">*</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>))
	<span style="color:#a6e22e">rsKey</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">KeyFunc</span>(<span style="color:#a6e22e">rs</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Couldn&#39;t get key for %v %#v: %v&#34;</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">err</span>))
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
    <span style="color:#75715e">//如果差值小于0，需要创建新的pod，通过slowStartBatch批量创建pod，返回成功创建的数量
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">diff</span> &lt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">diff</span> <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">diff</span> &gt; <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">burstReplicas</span> {
			<span style="color:#a6e22e">diff</span> = <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">burstReplicas</span>
		}
	
		<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">ExpectCreations</span>(<span style="color:#a6e22e">rsKey</span>, <span style="color:#a6e22e">diff</span>)
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Too few replicas for %v %s/%s, need %d, creating %d&#34;</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#f92672">*</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>), <span style="color:#a6e22e">diff</span>)
		
        <span style="color:#75715e">//通过slowStartBatch批量创建pod，返回成功创建的数量
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">successfulCreations</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slowStartBatch</span>(<span style="color:#a6e22e">diff</span>, <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">SlowStartInitialBatchSize</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
			<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">podControl</span>.<span style="color:#a6e22e">CreatePodsWithControllerRef</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>, <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">NewControllerRef</span>(<span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">GroupVersionKind</span>))
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		})

		<span style="color:#75715e">//对比差异，看还有缺多个pod没有创建
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">skippedPods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">diff</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">successfulCreations</span>; <span style="color:#a6e22e">skippedPods</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Slow-start failure. Skipping creation of %d pods, decrementing expectations for %v %v/%v&#34;</span>, <span style="color:#a6e22e">skippedPods</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Name</span>)
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">skippedPods</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
				<span style="color:#75715e">// Decrement the expected number of creates because the informer won&#39;t observe this pod
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">CreationObserved</span>(<span style="color:#a6e22e">rsKey</span>)
			}
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">diff</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#75715e">//如果diff 大于0，则说明需要进行删除pod
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">diff</span> &gt; <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">burstReplicas</span> {
			<span style="color:#a6e22e">diff</span> = <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">burstReplicas</span>
		}
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Too many replicas for %v %s/%s, need %d, deleting %d&#34;</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#f92672">*</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>), <span style="color:#a6e22e">diff</span>)

		<span style="color:#75715e">// 通过一定的策略返回需要删除的pod,	 not-ready &lt; ready, unscheduled &lt; scheduled, and pending &lt; running. 
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">podsToDelete</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getPodsToDelete</span>(<span style="color:#a6e22e">filteredPods</span>, <span style="color:#a6e22e">diff</span>)
	
		<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">ExpectDeletions</span>(<span style="color:#a6e22e">rsKey</span>, <span style="color:#a6e22e">getPodKeys</span>(<span style="color:#a6e22e">podsToDelete</span>))

		<span style="color:#a6e22e">errCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">diff</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">diff</span>)
        <span style="color:#75715e">//执行删除操作
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">podsToDelete</span> {
			<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">targetPod</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>) {
				<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">podControl</span>.<span style="color:#a6e22e">DeletePod</span>(<span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">targetPod</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">rs</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#75715e">// Decrement the expected number of deletes because the informer won&#39;t observe this deletion
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">podKey</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">PodKey</span>(<span style="color:#a6e22e">targetPod</span>)
					<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Failed to delete %v, decrementing expectations for %v %s/%s&#34;</span>, <span style="color:#a6e22e">podKey</span>, <span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">Kind</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">rs</span>.<span style="color:#a6e22e">Name</span>)
					<span style="color:#a6e22e">rsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">DeletionObserved</span>(<span style="color:#a6e22e">rsKey</span>, <span style="color:#a6e22e">podKey</span>)
					<span style="color:#a6e22e">errCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">err</span>
				}
			}(<span style="color:#a6e22e">pod</span>)
		}
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()

		<span style="color:#66d9ef">select</span> {
        <span style="color:#75715e">//如果某个一个goroutine有错误，则返回错误
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">errCh</span>:
			<span style="color:#75715e">// all errors have been reported before and they&#39;re likely to be the same, so we&#39;ll only return the first one we hit.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
			}
		<span style="color:#66d9ef">default</span>:
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="heading-4">总结</h3>
<p>目前为止，我们已经分析了controller manager是如何管理多个controller的，并且我们还分析了deployment controller和 replicaset controller的实现逻辑，可以看到controller整个框架逻辑是基本一致的，不同controller主要的不同就是
监听不同资源的add,update, delete，将相应的key添加到informer queue中，然后调用controller各自核心逻辑syncHanlder来实现谐调，最终使得集群应用达到用户期望。</p>
<p>比如大部分contoller逻辑都是如此，流程就是注册name+startcontrollerhandler到 controller manager中，比如<code>controllers[&quot;replicaset&quot;] = startReplicaSetController</code>
controller manager 会循环启动所有已经注册的name+startcontrollerhandler，对于每一个controller中的具体逻辑，又是通过NewxxxController.Run()的方式执行，
NewxxxCtronller是为了初始化controller，指定controller中需要监听的资源(比如，replicasetcontroller 他需要监听replicaset，pod这个两个资源的变化，而deploymentcontroller 它需要监听deployment,replicaset,pod这三个资源的变化, 具体变化包括add,update,delete
这三种操作，每个操作可以写相应的逻辑来更新informer catche，修改完成后将key入队)
初始化完资源后，调用Run方法，启动controller，此时Controller会启动指定数量个worker goroutine来从informer队列中拿到key，获取informer catche中的资源和实际集群中的资源进行比较，
此时就进入了每个worker goroutine的synchandler逻辑当中。synchanlder就是核心谐调逻辑。</p>
<p>而replicaset 中synchandler的核心逻辑就是<code>manageReplicas</code>，通过不断的对比期望pod，和实际pod差异来添加，或者删除pod。</p>
<p>接下来我会分析kubescheduler源码，欢迎阅读。[]()</p>

    </article>

    


    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/k8s/kube-scheduler-source-code-read/" data-toggle="tooltip" data-placement="top" title="K8S Scheduler 源码分析">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/k8s/controller-manager-source-code-read/" data-toggle="tooltip" data-placement="top" title="K8S Controller Manager 源码分析">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2017 Your name</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>


</body>
</html>
